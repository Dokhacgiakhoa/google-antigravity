const fs = require('fs');
const path = require('path');

const skillsDir = path.join(__dirname, '..', '..', '.agent', 'skills');
const outputFile = path.join(__dirname, '..', '..', 'cli', 'logic', 'skill-definitions.js');

// 1. Get all skill names
const allSkills = fs.readdirSync(skillsDir).filter(f => fs.statSync(path.join(skillsDir, f)).isDirectory());

// 2. Define Category Keywords (Priority Order matters for overlapping terms)
const categoryKeywords = {
    security: ['security', 'pentest', 'hack', 'malware', 'vulnerability', 'auth', 'compliance', 'red-team', 'forensics', 'exploit', 'owasp', 'scanning', 'threat', 'ssh', 'ssl', 'encryption', 'pci', 'gdpr', 'stride'],
    ai: ['ai-', 'llm', 'agent', 'langgraph', 'langchain', 'prompt', 'rag', 'vector', 'embedding', 'model', 'autogen', 'crewai', 'machine-learning', 'ml-', 'deep-learning', 'vision', 'voice', 'chatbot', 'gpt', 'claude', 'gemini', 'context'],
    mobile: ['mobile', 'android', 'ios', 'flutter', 'react-native', 'expo', 'swift', 'kotlin', 'app-store'],
    devops: ['devops', 'docker', 'kubernetes', 'k8s', 'terraform', 'aws', 'azure', 'gcp', 'cloud', 'ci/cd', 'pipeline', 'deploy', 'server', 'linux', 'bash', 'shell', 'monitor', 'observability', 'infra', 'terminal', 'powershell', 'bazel', 'turborepo', 'nx', 'git', 'ansible', 'helm', 'prometheus', 'grafana'],
    testing: ['test', 'tdd', 'playwright', 'cypress', 'selenium', 'puppeteer', 'jest', 'vitest', 'e2e', 'qa', 'quality', 'debugging', 'debugger'],
    uiux: ['ui', 'ux', 'design', 'css', 'tailwind', 'animation', 'style', 'theme', 'accessibility', 'wcag', 'canvas', 'svg', 'd3', 'icon', 'color', 'font', 'layout', 'responsive', 'frontend'],
    growth: ['seo', 'analytics', 'marketing', 'growth', 'copy', 'content', 'social', 'email', 'conversion', 'cro', 'pricing', 'sales', 'business', 'startup', 'product', 'advertising', 'ads'],
    webdev: ['web', 'react', 'next', 'vue', 'angular', 'svelte', 'html', 'javascript', 'typescript', 'node', 'express', 'nestjs', 'api', 'graphql', 'rest', 'backend', 'full-stack', 'frontend', 'wasm', 'pwa', 'remix', 'shopify', 'wordpress', 'django', 'flask', 'fastapi', 'php', 'ruby', 'rails', 'go-', 'rust', 'java', 'c-', 'cpp'],
    research: ['research', 'analysis', 'strategy', 'brainstorm', 'plan', 'document', 'architecture', 'diagram', 'uml', 'c4', 'review', 'audit'],
    // Maker matches everything else useful for building
    maker: ['tool', 'automation', 'productivity', 'notion', 'obsidian', 'workflow', 'script', 'bot', 'scraper', 'data', 'excel', 'csv', 'pdf', 'video', 'image', 'audio', 'file', 'mcp']
};

const categorizedSkills = {
    webdev: [],
    mobile: [],
    ai: [],
    research: [],
    uiux: [],
    devops: [],
    security: [],
    growth: [],
    maker: [],
    testing: []
};

const assignedSkills = new Set();

// 3. Auto-Categorize
allSkills.forEach(skill => {
    let assigned = false;
    const lowerName = skill.toLowerCase();

    // Check specific categories first
    for (const [cat, keywords] of Object.entries(categoryKeywords)) {
        if (keywords.some(k => lowerName.includes(k))) {
            categorizedSkills[cat].push(skill);
            assignedSkills.add(skill);
            assigned = true;
            break; // Assign to first matching category (priority based on order in object)
        }
    }

    // Fallback logic
    if (!assigned) {
        // If not assigned, put in 'maker' as general tools
        categorizedSkills.maker.push(skill);
    }
});

// 4. Generate File Content
const fileContent = `/**
 * Centralized definition of all Agent Skills and their categories.
 * Auto-generated by .agent/scripts/generate-skill-definitions.js
 * Total Skills: ${allSkills.length}
 */

const skillCategories = {
  webdev: {
    name: 'Web High-Performance (Vercel & Antfu Grade)',
    skills: ${JSON.stringify(categorizedSkills.webdev, null, 2).replace(/"/g, "'")}
  },
  mobile: {
    name: 'Mobile Development (iOS, Android, Cross-Platform)',
    skills: ${JSON.stringify(categorizedSkills.mobile, null, 2).replace(/"/g, "'")}
  },
  ai: {
    name: 'Advanced AI & Research (AutoGen & LangGraph)',
    skills: ${JSON.stringify(categorizedSkills.ai, null, 2).replace(/"/g, "'")}
  },
  research: {
    name: 'Strategic Research & Wisdom (Fabric Patterns)',
    skills: ${JSON.stringify(categorizedSkills.research, null, 2).replace(/"/g, "'")}
  },
  uiux: {
    name: 'UI/UX Pro Max (NextLevel Aesthetics)',
    skills: ${JSON.stringify(categorizedSkills.uiux, null, 2).replace(/"/g, "'")}
  },
  devops: {
    name: 'DevOps & Cloud (Enterprise Grade)',
    skills: ${JSON.stringify(categorizedSkills.devops, null, 2).replace(/"/g, "'")}
  },
  security: {
    name: 'Security & Compliance (Fintech Standards)',
    skills: ${JSON.stringify(categorizedSkills.security, null, 2).replace(/"/g, "'")}
  },
  growth: {
    name: 'Growth & Business Intelligence',
    skills: ${JSON.stringify(categorizedSkills.growth, null, 2).replace(/"/g, "'")}
  },
  maker: {
    name: 'Maker & Indie Hacking (Sickn33) ',
    skills: ${JSON.stringify(categorizedSkills.maker, null, 2).replace(/"/g, "'")}
  },
  testing: {
    name: 'Professional QA & Testing',
    skills: ${JSON.stringify(categorizedSkills.testing, null, 2).replace(/"/g, "'")}
  }
};

function getSkillsForCategories(categories) {
  const skills = [];
  categories.forEach(category => {
    if (skillCategories[category]) {
      skills.push(...skillCategories[category].skills);
    }
  });
  return skills;
}

module.exports = {
  skillCategories,
  getSkillsForCategories
};
`;

// 5. Write File
fs.writeFileSync(outputFile, fileContent);
console.log(`Successfully generated skill definitions for ${allSkills.length} skills.`);
console.log('Breakdown:');
Object.keys(categorizedSkills).forEach(cat => {
    console.log(`  - ${cat}: ${categorizedSkills[cat].length}`);
});
